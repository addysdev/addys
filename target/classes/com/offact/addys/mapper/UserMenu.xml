<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="UserMenu">

	<resultMap id="userMenuVO" type="com.offact.addys.vo.UserMenuVO" >
	    <result column="USER_ID" property="USER_ID"  />
	    <result column="USER_NM" property="USER_NM"  />
	    <result column="USER_DEPT_CODE" property="USER_DEPT_CODE"  />
	    <result column="DEPT_NAME" property="DEPT_NAME"  />
	    <result column="FUNC_AUTH_CODE" property="FUNC_AUTH_CODE"  />
	    <result column="FUNC_AUTH_NM" property="FUNC_AUTH_NM"  />
	    <result column="MENU_ID" property="MENU_ID"  />
	    <result column="MENU_NM" property="MENU_NM"  />
	    <result column="UPPER_MENU_CODE" property="UPPER_MENU_CODE"  />
	    <result column="UPPER_MENU_NM" property="UPPER_MENU_NM"  />
	</resultMap>
  
	<select id="getUserMenuList" resultType="com.offact.addys.vo.UserMenuVO" parameterType="com.offact.addys.vo.UserMenuVO" >            
            SELECT 
			        CASE WHEN X.UPPER_MENU_NAME IS NOT NULL THEN X.UPPER_MENU_NAME ELSE X.MENU_NM END MENU_NM
			        , X.MENU_ID
			        , X.MENU_URL
			        , X.USER_ID
			        , X.USER_NM
			        , X.USER_DEPT_CODE
			FROM (
			              SELECT DISTINCT
			                  (SELECT TC.NAME FROM TB_CODE TC WHERE TC.CODE_ID = 'IG30' AND TC.CODE=TM.UPPER_MENU_CODE) AS UPPER_MENU_NAME
			                  , TM.UPPER_MENU_CODE AS UPPER_MENU_CODE
			                  , NULL AS MENU_ID
			                  , NULL  AS MENU_NM  
			                  , NULL  AS MENU_URL
			                  , '0' AS MENU_DISPLAY_ORDER
			                  , TU.USER_ID
			                  , TU.USER_NM
			                  , TU.USER_DEPT_CODE
			              FROM TB_USER TU
			                 INNER JOIN TB_USER_AUTH TUA
			                            ON TU.USER_ID = TUA.USER_ID
			                 INNER JOIN TB_FUNC_CLASS TFC 
			                            ON  TUA.USER_DEPT_CODE = TFC.USER_DEPT_CODE
			                            AND TUA.FUNC_AUTH_CODE = TFC.FUNC_AUTH_CODE
			                            AND TFC.MENU_YN='Y'
			                 INNER JOIN TB_MENU TM
			                            ON  TFC.MENU_ID = TM.MENU_ID
			               WHERE  TU.USER_ID = #{USER_ID} 
			
			              UNION ALL
			
			              SELECT 
			                  NULL AS UPPER_MENU_NAME
			                  , TM.UPPER_MENU_CODE AS UPPER_MENU_CODE
			                  , TM.MENU_ID AS MENU_ID
			                  , TM.MENU_NM  AS MENU_NM
			                  , TM.MENU_URL AS MENU_URL
			                  , TM.MENU_DISPLAY_ORDER AS MENU_DISPLAY_ORDER
			                  , TU.USER_ID
			                  , TU.USER_NM
			                  , TU.USER_DEPT_CODE
			              FROM TB_USER TU
			                 INNER JOIN TB_USER_AUTH TUA
			                            ON TU.USER_ID = TUA.USER_ID
			                 INNER JOIN TB_FUNC_CLASS TFC 
			                            ON  TUA.USER_DEPT_CODE = TFC.USER_DEPT_CODE
			                            AND TUA.FUNC_AUTH_CODE = TFC.FUNC_AUTH_CODE
			                            AND TFC.MENU_YN='Y'
			                 INNER JOIN TB_MENU TM
			                            ON  TFC.MENU_ID = TM.MENU_ID
			               WHERE  TU.USER_ID = #{USER_ID} 
			          ) X
			 GROUP BY  X.UPPER_MENU_CODE
			        , X.MENU_ID
			        , X.MENU_NM
			        , X.MENU_URL
			        , X.USER_ID
			        , X.USER_NM
			        , X.USER_DEPT_CODE
	</select>
  	
  	<select id="getCheckUserValidate" resultType="com.offact.addys.vo.UserMenuVO" parameterType="com.offact.addys.vo.UserMenuVO" >            
            SELECT
				  USER_ID
				  , USER_NM
				  , USER_DEPT_CODE 
			FROM TB_USER
			WHERE USER_ID=#{USER_ID} 
	</select>
  	
  	<select id="getAuthPerMenu" resultType="com.offact.addys.vo.UserMenuVO" parameterType="com.offact.addys.vo.UserMenuVO" >            
  			SELECT 
			     TFC.FUNC_AUTH_CODE
			    , TFC.FUNC_AUTH_NM
			FROM TB_USER TU
			   INNER JOIN TB_USER_AUTH TUA
			              ON TU.USER_ID = TUA.USER_ID
			   INNER JOIN TB_FUNC_CLASS TFC 
			              ON  TUA.USER_DEPT_CODE = TFC.USER_DEPT_CODE
			              AND TUA.FUNC_AUTH_CODE = TFC.FUNC_AUTH_CODE
			WHERE  TU.USER_ID = #{USER_ID} 
				   AND TFC.MENU_YN ='Y'	
				   AND now() BETWEEN TUA.VALID_FROM_DT AND TUA.VALID_TO_DT
				   AND TUA.AUTH_YN = 'Y'
  	</select>
  	
  	<select id="getAuthPerFunction" resultType="com.offact.addys.vo.UserMenuVO" parameterType="com.offact.addys.vo.UserMenuVO" >            
  			SELECT 
			     TFC.FUNC_AUTH_CODE
			    , TFC.FUNC_AUTH_NM
			FROM TB_USER TU
			   INNER JOIN TB_USER_AUTH TUA
			              ON TU.USER_ID = TUA.USER_ID
			   INNER JOIN TB_FUNC_CLASS TFC 
			              ON  TUA.USER_DEPT_CODE = TFC.USER_DEPT_CODE
			              AND TUA.FUNC_AUTH_CODE = TFC.FUNC_AUTH_CODE
			WHERE  TU.USER_ID = #{USER_ID} 
				   AND TFC.MENU_YN ='N'	
				   AND now() BETWEEN TUA.VALID_FROM_DT AND TUA.VALID_TO_DT		              
                   AND TUA.AUTH_YN = 'Y'
  	</select>
  	
  	  	<select id="getAuthPerSuper" resultType="com.offact.addys.vo.UserMenuVO" parameterType="com.offact.addys.vo.UserMenuVO" >            
  			 SELECT 
			     FUNC_AUTH_CODE
			    ,FUNC_AUTH_NM
			FROM TB_FUNC_CLASS 
			WHERE USER_DEPT_CODE = #{USER_DEPT_CODE} 
            And MENU_YN =#{MENU_YN} 	
  	</select>
  	
</mapper>
